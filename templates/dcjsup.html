<!DOCTYPE html>
<html lang="en">
<head>
    <title>DC Chart for Jawbone UP Data</title>
    <meta charset="UTF-8">
    <!-- bootstrap -->
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/dc.css') }}"/>
</head>
<body>

<div class="row">
  <div class="col-md-6">
    <h4>Total Calories by Month</h4>
    <div id="calchart"></div>
  </div>
  <div class="col-md-6">
    <h4>Total Sleep by day of week</h4>
    <div id="sleepbar"></div>
  </div>
  </div>

  <div class="row">
  <div class="col-md-6">
  <h4>Sleep Interval Bubble</h4>
  <div id="slbubble"></div>
  </div>
  <div class="col-md-6">
  <h4>Sleep Quality by resting Heart Rate</h4>
  <div id="sleeppie"></div>
  </div>  
</div>

<script type="text/javascript" src="{{ url_for('static',filename='js/d3.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static',filename='js/crossfilter.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static',filename='js/dc-1.6.0.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static',filename='js/colorbrewer.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static',filename='js/moment.js')}}"></script>

<script type="text/javascript">

var calChart = dc.barChart("#calchart");
var slBubble = dc.bubbleChart("#slbubble");
var sleepBar = dc.barChart("#sleepbar");
var sleepPie = dc.pieChart("#sleeppie");

d3.csv("../static/data/AllUPs.csv", function(error, data) {

  var dateFormat = d3.time.format("%m/%d/%Y");
  var numberFormat = d3.format(".2f");
  
  // Parse date
  data.forEach(function (d) {
    d.month = parseInt((d.DATE).substring(4,6));
    d.wkday = moment(d.DATE, 'YYYYMMDD').weekday();
    // d.wkday = moment(d.DATE, 'YYYYMMDD').format("ddd");
    // console.log(d.wkday);
  })

  var ups = crossfilter(data);
  var monthlyDimension = ups.dimension(function (d) {return +d.month; });
  var weekdayDimension = ups.dimension(function (d) {return +d.wkday+1; });

  var upCalMonth = monthlyDimension.group().reduceSum(function(d) {return +d.e_calories;});

  var upSugarMonth = monthlyDimension.group().reduceSum(function(d) {return +d.e_sugars;});

  var upSleepDay = weekdayDimension.group().reduceSum(function(d) {return d.s_asleep_time;});

  var weekdayValueGroup = weekdayDimension.group().reduce(
    // add
    function (p, v) {
      ++p.count;
      p.slint += v.s_asleep_time;
      p.slint_avg = p.slint / p.count;
      p.awakeInt += v.s_awake_time;
      p.deepInt += v.s_deep;
      p.lightInt += v.s_light; 
      p.slDuration += v.s_duration;
      p.s_quality += v.s_quality; 
      return p;
    },
    // remove
    function (p, v) {
      --p.count;
      p.slint -= v.s_asleep_time;
      p.slint_avg = p.slint / p.count;
      p.awakeInt -= v.s_awake_time;
      p.deepInt -= v.s_deep;
      p.lightInt -= v.s_light; 
      p.slDuration -= v.s_duration;
      p.slQuality -= v.s_quality; 
      return p;
    },
    // initialize
    function () {
      return {count: 0, slint:0, slint_avg: 0,
        awakeInt: 0, deepInt: 0, lightInt: 0, slDuration: 0, slQuality:0};
    }
    )

  var monthlyValueGroup = monthlyDimension.group().reduce(
    // add
    function (p, v) {
      ++p.count; 
      p.carbs += v.e_carbs;
      p.carbs_avg = p.carbs / p.count;
      p.protein += v.e_protein;
      p.protein_avg = p.protein / p.count;
      return p;
    }, 
    // remove
    function (p, v) {
      --p.count; 
      p.carbs -= v.e_carbs;
      p.carbs_avg = p.carbs / p.count;
      p.protein -= v.e_protein;
      p.protein_avg = p.protein / p.count;
      return p;
    },
    /* initialize p */
    function () {
      return {count: 0, carbs: 0, carbs_avg: 0, protein: 0, protein_avg: 0};
    }
  );

  calChart
    .width(400)
    .height(280)
    .margins({top: 10, right: 50, bottom: 30, left: 50})
    .x(d3.scale.linear().domain([0, 12]))
    .brushOn(false)
    .xAxisLabel("Months")
    .yAxisLabel("Total Calories Recorded")
    .dimension(monthlyDimension, "Monthly Value Group")
    .group(upCalMonth)
    .elasticY(true)
    .centerBar(true)
    .gap(1);

  calChart.render();

  sleepBar
    .width(400)
    .height(280)
    .margins({top: 10, right: 50, bottom: 30, left: 50})
    .x(d3.scale.linear().domain([0.5, 7.5]))
    .brushOn(false)
    .xAxisLabel("Day of Week")
    .yAxisLabel("Total sleep minutes")
    .dimension(weekdayDimension, "Monthly Value Group")
    .group(upSleepDay)
    .elasticY(true)
    .centerBar(true)
    .gap(1);

  sleepBar.render();  

  slBubble
    .width(400)
    .height(280)
    .transitionDuration(1500)
    .margins({top: 10, right: 10, bottom: 30, left: 50})
    .dimension(weekdayDimension)
    .group(weekdayValueGroup)
    .colors(colorbrewer.RdYlGn[9]) // color function or array for bubbles
    .colorDomain([0, 500])
    .colorAccessor(function (p) {
      // console.log(p.value);
      return Math.random()*parseInt(p.value.awakeInt);})
    .keyAccessor(function (p) {return 0.01*Math.random()+parseInt(p.key);})
    .valueAccessor(function (p) {return parseInt(p.value.slint);})
    .radiusValueAccessor(function (p) {return parseInt(p.value.awakeInt);})
    .maxBubbleRelativeSize(0.1)
    .x(d3.scale.linear().domain([0, 10]))
    .y(d3.scale.linear().domain([0, 2000]))
    .r(d3.scale.linear().domain([0, 1000]))
    .xAxisLabel("Month")
    .yAxisLabel("Sleep Interval")
    // .elasticY(true)
    .elasticX(true); 

  slBubble.render();
});

d3.csv("../static/data/allBBnoNaN.csv", function(error, data) {
  var dateFormat = d3.time.format("%m/%d/%Y");
  var numberFormat = d3.format(".2f");

  data.forEach(function (d) {
    d.dd = dateFormat.parse(d.date); 
    d.month = d3.time.month(d.dd);
  })

  var slp           = crossfilter(data),
      slDimension   = slp.dimension(function(d) {return +d.sleepIntervalIndex;}),
      slSumGroup    = slDimension.group().reduceSum(function(d) {
        return d.sleepQuality * d.restingHR / 1000;});

  var dateDimension = slp.dimension(function (d) {
    return d.dd;
  });

  var slMonths = slp.dimension(function (d) {
    return d.month;
  });

  // dc.barChart("#sleep quality chart")
  sleepPie
    .width(280)
    .height(280)
    .renderLabel(true)
    .innerRadius(35)
    .transitionDuration(500)
    .dimension(slDimension)
    .group(slSumGroup)
    // .label(function (d) {
    //   if (sleepPie.hasFilter() && !sleepPie.hasFilter(d.key))
    //     return d.key + "(0%)";
    //   return d.key + "(" + Math.floor(d.sleepIntervalIndex) + "%)";
    // })
    .renderLabel(true);

  sleepPie.render();
});

</script>

</body>
</html>